<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Â±ÖÈÖíÂ±ã„É°„Éã„É•„ÉºË®àÁÆóÊ©ü</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <link rel="stylesheet" href="style.css">
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #fff;
      font-size: 16px;
      -webkit-tap-highlight-color: transparent;
    }
    .app-bar {
      background: #e53935;
      color: #fff;
      font-size: 1.2em;
      padding: 0.7em 0.5em;
      text-align: center;
      letter-spacing: 0.1em;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .tab-wrap {
      display: flex;
      overflow-x: auto;
      border-bottom: 1px solid #eee;
      background: #fff;
      position: sticky;
      top: 2.5em;
      z-index: 9;
    }
    .tab {
      flex: 1 0 auto;
      padding: 0.7em 0.5em;
      border: none;
      background: none;
      font-size: 1em;
      color: #e53935;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: border 0.15s, color 0.15s;
      min-width: 90px;
      white-space: nowrap;
    }
    .tab.active {
      border-bottom: 2.5px solid #e53935;
      color: #b71c1c;
      font-weight: bold;
      background: #fff5f5;
    }
    .menu-panel {
      display: none;
      padding: 0.7em 0.5em 0.5em 0.5em;
    }
    .menu-panel.active {
      display: block;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.7em;
    }
    @media (max-width: 480px) {
      .grid {
        grid-template-columns: 1fr;
      }
      .tab, .drink-subtab {
        font-size: 0.98em;
        min-width: 80px;
      }
    }
    .menu-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(200,0,0,0.07);
      padding: 1em 0.7em;
      text-align: center;
      cursor: pointer;
      transition: box-shadow 0.13s, background 0.13s;
      border: 1px solid #f5caca;
      font-size: 1em;
      user-select: none;
    }
    .menu-card:active {
      background: #ffeaea;
      box-shadow: 0 1px 4px rgba(200,0,0,0.13);
    }
    .menu-name {
      font-weight: bold;
      font-size: 1.08em;
      margin-bottom: 0.2em;
      color: #b71c1c;
    }
    .menu-price {
      color: #e53935;
      font-size: 1em;
      margin-bottom: 0.1em;
    }
    .cart-wrap {
      background: #fff8f8;
      border-top: 2px solid #e53935;
      padding: 0.7em 0.5em 0.5em 0.5em;
      position: sticky;
      bottom: 0;
      z-index: 11;
      box-shadow: 0 -2px 8px rgba(200,0,0,0.07);
    }
    .cart-table {
      width: 100%;
      font-size: 0.97em;
      border-collapse: collapse;
      margin-bottom: 0.3em;
    }
    .cart-table th, .cart-table td {
      padding: 0.3em 0.2em;
      text-align: center;
    }
    .cart-table th {
      background: #ffeaea;
      color: #b71c1c;
      font-weight: bold;
    }
    .qty-btn, .cart-btn {
      background: #e53935;
      color: #fff;
      border: none;
      border-radius: 5px;
      font-size: 1em;
      padding: 0.2em 0.7em;
      margin: 0 0.1em;
      cursor: pointer;
      transition: background 0.13s;
    }
    .qty-btn:active, .cart-btn:active {
      background: #b71c1c;
    }
    .custom-menu-wrap {
      margin: 1em 0 0.5em 0;
      text-align: center;
      background: #fff5f5;
      padding: 0.7em 0.5em 0.7em 0.5em;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(200,0,0,0.07);
      position: sticky;
      top: 5.5em;
      z-index: 8;
    }
    .custom-menu-wrap input {
      font-size: 1em;
      padding: 0.4em;
      border: 1px solid #e53935;
      border-radius: 6px;
      margin-right: 0.3em;
      width: 44vw;
      max-width: 140px;
      box-sizing: border-box;
    }
    .custom-menu-wrap input[type="number"] {
      max-width: 90px;
    }
    .custom-menu-wrap .save-btn {
      font-size: 1em;
      padding: 0.4em 1.2em;
      border-radius: 6px;
      background: #e53935;
      color: #fff;
      border: none;
      cursor: pointer;
      margin-left: 0.3em;
    }
    .custom-menu-wrap .save-btn:active {
      background: #b71c1c;
    }
    footer {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100vw;
      z-index: 5;
    }
    .bottom-navbar {
      display: flex;
      background: #fff;
      border-top: 1.5px solid #e53935;
      height: 60px;
      box-shadow: 0 -2px 8px rgba(200,0,0,0.07);
    }
    .nav-btn {
      flex: 1;
      border: none;
      background: none;
      font: inherit;
      color: #e53935;
      font-size: 1.02em;
      padding: 0 0 2px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      outline: none;
      cursor: pointer;
      transition: background 0.13s;
      border-radius: 0;
      height: 100%;
      user-select: none;
      min-width: 0;
      white-space: nowrap;
    }
    .nav-btn span {
      font-size: 1.35em;
      display: block;
      margin-bottom: 0.1em;
      line-height: 1;
      width: 1.5em;
      text-align: center;
      vertical-align: middle;
    }
    .nav-btn.active, .nav-btn:active {
      background: #ffeaea;
      color: #b71c1c;
      font-weight: bold;
    }
    @media (max-width: 640px) {
      .bottom-navbar { height: 62px; }
      .nav-btn { font-size: 0.98em; }
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    const firebaseConfig = {
      apiKey: "AIzaSyAluOeFF-oeeYMf7qe3b2vQyMsO_0oetW8",
      authDomain: "izakaya-staff-app.firebaseapp.com",
      projectId: "izakaya-staff-app",
      storageBucket: "izakaya-staff-app.firebasestorage.app",
      messagingSenderId: "44853351550",
      appId: "1:44853351550:web:3b089746d5031ce82cf42f",
      measurementId: "G-9HX2780DVZ"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db;
    window.fs = { collection, query, orderBy, getDocs };
  </script>
</head>
<body>
  <div class="app-bar">„É°„Éã„É•„ÉºË®àÁÆóÊ©ü</div>
  <div id="tab-container" class="tab-wrap"></div>
  <div id="drink-subtab-container" class="tab-wrap" style="display:none;"></div>
  <div class="custom-menu-wrap">
    <input id="custom-menu-name" type="text" placeholder="„Ç´„Çπ„Çø„É†ÂïÜÂìÅÂêç" autocomplete="off">
    <input id="custom-menu-price" type="number" placeholder="ÈáëÈ°ç" autocomplete="off">
    <button id="custom-menu-add" class="save-btn">„Ç´„Çπ„Çø„É†ËøΩÂä†</button>
  </div>
  <div id="menu-panels"></div>
  <div class="cart-wrap" id="cart-wrap" style="display:none;">
    <div id="cart-summary" style="font-weight:bold; margin-bottom:0.3em;"></div>
    <div id="cart-total" style="font-weight:bold; margin-bottom:0.3em; color:#b71c1c;"></div>
    <div class="cart-title" id="cart-title" style="cursor:pointer; user-select:none;">
      üõí ÈÅ∏Êäû‰∏≠„É°„Éã„É•„Éº <span id="cart-toggle" style="font-size:0.95em; margin-left:8px;">‚ñº</span>
    </div>
    <div id="cart-detail">
      <table class="cart-table" id="cart-table"></table>
    </div>
  </div>
  <footer>
    <nav class="bottom-navbar">
      <button class="nav-btn active" id="nav-menu"><span>üçΩÔ∏è</span><br>„É°„Éã„É•„ÉºË®àÁÆóÊ©ü</button>
      <button class="nav-btn" id="nav-inventory"><span>üì¶</span><br>Âú®Â∫´ÁÆ°ÁêÜ</button>
      <button class="nav-btn" id="nav-sake"><span>üç∂</span><br>Êó•Êú¨ÈÖí</button>
      <button class="nav-btn" id="nav-menu-edit"><span>üìù</span><br>„É°„Éã„É•„ÉºÁÆ°ÁêÜ</button>
    </nav>
  </footer>
<script>
  // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„Éú„Çø„É≥„ÅÆ„Éö„Éº„Ç∏ÈÅ∑Áßª
  document.getElementById('nav-menu').onclick = () => location.href = 'index.html';
  document.getElementById('nav-inventory').onclick = () => location.href = 'inventory.html';
  document.getElementById('nav-sake').onclick = () => location.href = 'sake.html';
  document.getElementById('nav-menu-edit').onclick = () => location.href = 'menu_edit.html';
</script>
<script type="module">
  // --- „Ç´„ÉÜ„Ç¥„É™ÔºÜ„Éâ„É™„É≥„ÇØ„Çµ„Éñ„Ç´„ÉÜ„Ç¥„É™„ÅÆÂõ∫ÂÆöÈ†Ü ---
  const fixedCategories = [
    '„Éâ„É™„É≥„ÇØ', 'ÁÑº„ÅçÁâ©', '‰∏ÄÂìÅÊñôÁêÜ', '„Åä„Å§„Åæ„Åø', '„Çµ„É©„ÉÄ', 'Èçã', '„Éà„ÉÉ„Éî„É≥„Ç∞', '„ÄÜ„É°„Éã„É•„Éº', '„Éá„Ç∂„Éº„Éà', '„Åù„ÅÆ‰ªñ'
  ];
  const drinkOrder = [
    '„Éì„Éº„É´', '„Çµ„ÉØ„Éº', '„Éè„Ç§„Éú„Éº„É´', 'Êó•Êú¨ÈÖí', 'ÁÑºÈÖé', '„ÉØ„Ç§„É≥', '„ÇΩ„Éï„Éà„Éâ„É™„É≥„ÇØ', '„Åù„ÅÆ‰ªñ'
  ];

  const tabContainer = document.getElementById('tab-container');
  const drinkSubtabContainer = document.getElementById('drink-subtab-container');
  const menuPanels = document.getElementById('menu-panels');
  let menuItems = []; // ÂÖ®„É°„Éã„É•„Éº
  let cart = []; // {name, price, qty}
  let currentTabIdx = 0;
  let currentDrinkSubIdx = 0;
  let otoshiAdded = false; // „ÅäÈÄö„ÅóËøΩÂä†„Éï„É©„Ç∞

  // --- Firestore„Åã„Çâ„É°„Éã„É•„Éº„Ç¢„Ç§„ÉÜ„É†„ÇíÂèñÂæó ---
  const { db, fs } = window;
  const { collection, query, orderBy, getDocs } = fs;

  // „Ç´„Çπ„Çø„É†„É°„Éã„É•„Éº„ÅØ„Äå„Åù„ÅÆ‰ªñ„Äç„Ç´„ÉÜ„Ç¥„É™„Å´ËøΩÂä†
  let customMenuItems = [];

  async function fetchMenuItems() {
    const menuCol = collection(db, 'menu_items');
    const q = query(menuCol, orderBy('category'));
    const snap = await getDocs(q);
    menuItems = [];
    snap.forEach(d => menuItems.push({id:d.id, ...d.data()}));
    otoshiAdded = false; // „É°„Éã„É•„ÉºÊõ¥Êñ∞ÊôÇ„ÅØ„É™„Çª„ÉÉ„Éà
    renderMenuTabs();
    addOtoshiIfNeeded();
  }

  // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆ„ÅøÂèñÂæó
  window.addEventListener('DOMContentLoaded', fetchMenuItems);

  // --- „ÅäÈÄö„ÅóËá™ÂãïËøΩÂä† ---
  function addOtoshiIfNeeded() {
    if (otoshiAdded) return;
    const otoshi = menuItems.find(item => item.name === '„ÅäÈÄö„Åó');
    if (otoshi) {
      if (!cart.some(e => e.name === '„ÅäÈÄö„Åó')) {
        cart.unshift({ name: otoshi.name, price: otoshi.price, qty: 1 });
      }
      otoshiAdded = true;
      renderCart();
    }
  }

  // --- „Ç´„ÉÜ„Ç¥„É™„Çø„Éñ„Å®„É°„Éã„É•„Éº„Éë„Éç„É´ÊèèÁîª ---
  function renderMenuTabs() {
    // „Ç∞„É´„Éº„ÉóÂåñ
    const grouped = {};
    menuItems.forEach(item => {
      const cat = item.category || '„Åù„ÅÆ‰ªñ';
      if (!grouped[cat]) grouped[cat] = [];
      grouped[cat].push(item);
    });
    // „Ç´„Çπ„Çø„É†„É°„Éã„É•„Éº„Çí„Äå„Åù„ÅÆ‰ªñ„Äç„Å´ËøΩÂä†
    if (customMenuItems.length) {
      if (!grouped['„Åù„ÅÆ‰ªñ']) grouped['„Åù„ÅÆ‰ªñ'] = [];
      grouped['„Åù„ÅÆ‰ªñ'] = [...customMenuItems, ...(grouped['„Åù„ÅÆ‰ªñ'] || [])];
    }

    // „Çø„ÉñÈ†Ü
    const categories = fixedCategories.filter(c => grouped[c]);
    tabContainer.innerHTML = '';
    menuPanels.innerHTML = '';
    drinkSubtabContainer.style.display = 'none';

    // „Çø„Éñ‰ΩúÊàê
    categories.forEach((cat, idx) => {
      const btn = document.createElement('button');
      btn.className = 'tab' + (idx===0?' active':'');
      btn.textContent = cat;
      btn.onclick = () => switchTab(idx);
      tabContainer.appendChild(btn);
    });

    // „Éë„Éç„É´‰ΩúÊàê
    categories.forEach((cat, idx) => {
      const panel = document.createElement('div');
      panel.className = 'menu-panel' + (idx===0?' active':'');
      panel.dataset.cat = cat;
      menuPanels.appendChild(panel);
    });

    // ÂàùÊúüË°®Á§∫
    renderMenuPanel(categories[0], 0);
  }

  // --- „Çø„ÉñÂàáÊõø ---
  function switchTab(idx) {
    currentTabIdx = idx;
    document.querySelectorAll('.tab').forEach((el,i) => el.classList.toggle('active',i===idx));
    document.querySelectorAll('.menu-panel').forEach((el,i) => el.classList.toggle('active',i===idx));
    const categories = Array.from(document.querySelectorAll('.tab')).map(el => el.textContent);
    renderMenuPanel(categories[idx], idx);
  }

  // --- „Çµ„Éñ„Çø„ÉñÂàáÊõø ---
  function switchDrinkSubTab(subIdx) {
    currentDrinkSubIdx = subIdx;
    document.querySelectorAll('.drink-subtab').forEach((el,i) => el.classList.toggle('active',i===subIdx));
    renderMenuPanel('„Éâ„É™„É≥„ÇØ', currentTabIdx, subIdx);
  }

  // --- „É°„Éã„É•„Éº„Éë„Éç„É´ÊèèÁîª ---
  function renderMenuPanel(cat, idx, drinkSubIdx = 0) {
    const panel = document.querySelectorAll('.menu-panel')[idx];
    panel.innerHTML = '';
    if (cat === '„Éâ„É™„É≥„ÇØ') {
      // „Çµ„Éñ„Ç´„ÉÜ„Ç¥„É™„Åß„Ç∞„É´„Éº„ÉóÂåñ
      const grouped = {};
      menuItems.filter(item => item.category === '„Éâ„É™„É≥„ÇØ').forEach(item => {
        const sub = item.subCategory || '„Åù„ÅÆ‰ªñ';
        if (!grouped[sub]) grouped[sub] = [];
        grouped[sub].push(item);
      });
      const sortedSub = [
        ...drinkOrder.filter(s => grouped[s]),
        ...Object.keys(grouped).filter(s => !drinkOrder.includes(s)),
      ];
      // „Çµ„Éñ„Çø„ÉñÁîüÊàê
      drinkSubtabContainer.innerHTML = '';
      drinkSubtabContainer.style.display = 'flex';
      sortedSub.forEach((sub, i) => {
        const btn = document.createElement('button');
        btn.className = 'tab drink-subtab' + (i===drinkSubIdx?' active':'');
        btn.textContent = sub;
        btn.onclick = () => switchDrinkSubTab(i);
        drinkSubtabContainer.appendChild(btn);
      });
      // „Çµ„Éñ„Ç´„ÉÜ„Ç¥„É™„ÅÆ„Ç∞„É™„ÉÉ„Éâ„ÅÆ„ÅøË°®Á§∫
      const subCat = sortedSub[drinkSubIdx] || sortedSub[0];
      if (subCat) {
        const grid = document.createElement('div');
        grid.className = 'grid';
        grouped[subCat].forEach(item => grid.appendChild(buildMenuCard(item)));
        panel.appendChild(grid);
      }
    } else {
      drinkSubtabContainer.style.display = 'none';
      // „Åù„ÅÆ‰ªñ„Ç´„ÉÜ„Ç¥„É™„ÅØÈÄöÂ∏∏„Ç∞„É™„ÉÉ„Éâ
      const grid = document.createElement('div');
      grid.className = 'grid';
      // „Ç´„Çπ„Çø„É†„É°„Éã„É•„Éº„ÇÇÂê´„ÇÅ„Å¶Ë°®Á§∫
      let items = [];
      if (cat === '„Åù„ÅÆ‰ªñ' && customMenuItems.length) {
        items = [...customMenuItems, ...menuItems.filter(item => (item.category || '„Åù„ÅÆ‰ªñ') === cat)];
      } else {
        items = menuItems.filter(item => (item.category || '„Åù„ÅÆ‰ªñ') === cat);
      }
      items.forEach(item => grid.appendChild(buildMenuCard(item)));
      panel.appendChild(grid);
    }
  }

  // --- „É°„Éã„É•„Éº„Ç´„Éº„Éâ ---
  function buildMenuCard(item) {
    const card = document.createElement('div');
    card.className = 'menu-card';
    card.innerHTML = `<div class="menu-name">${item.name}</div>
      <div class="menu-price">¬•${item.price}</div>`;
    card.onclick = () => addToCart(item.name, item.price, 1);
    return card;
  }

  // --- „Ç´„Éº„Éà„Å´ËøΩÂä† ---
  function addToCart(name, price, qty) {
    addOtoshiIfNeeded();
    const idx = cart.findIndex(e => e.name === name && e.price === price);
    if (idx >= 0) cart[idx].qty += qty;
    else cart.push({ name, price, qty });
    renderCart();
  }

  // --- „Ç´„Éº„ÉàË°®Á§∫„ÉªÊï∞ÈáèÂ§âÊõ¥ ---
  let cartExpanded = true;
  function renderCart() {
    const wrap = document.getElementById('cart-wrap');
    const table = document.getElementById('cart-table');
    const detail = document.getElementById('cart-detail');
    const toggle = document.getElementById('cart-toggle');
    const summary = document.getElementById('cart-summary');
    const totalEl = document.getElementById('cart-total');
    if (!cart.length) { wrap.style.display = 'none'; return; }
    wrap.style.display = 'block';

    // Â∞èË®à„ÉªÁ®éËæº„ÅøË®àÁÆó
    const subtotal = cart.reduce((sum,e)=>sum+e.price*e.qty,0);
    const tax = Math.round(subtotal * 0.1);
    const total = subtotal + tax;
    summary.innerHTML = `Â∞èË®à: ¬•${subtotal.toLocaleString()}„ÄÄÁ®éËæº: ¬•${total.toLocaleString()}`;
    totalEl.innerHTML = `ÂêàË®à: <span style="font-size:1.13em;">¬•${total.toLocaleString()}</span>`;

    // Â±ïÈñã„ÉªÊ†ºÁ¥ç
    detail.style.display = cartExpanded ? 'block' : 'none';
    toggle.textContent = cartExpanded ? '‚ñº' : '‚ñ≤';

    table.innerHTML = `
      <tr>
        <th>ÂïÜÂìÅÂêç</th><th>Âçò‰æ°</th><th>Êï∞Èáè</th><th></th><th>Â∞èË®à</th>
      </tr>
      ${cart.map((item, i) => `
        <tr>
          <td>${item.name}</td>
          <td>¬•${item.price}</td>
          <td>
            <button class="qty-btn" onclick="window.changeQty(${i},-1)">‚àí</button>
            ${item.qty}
            <button class="qty-btn" onclick="window.changeQty(${i},1)">Ôºã</button>
          </td>
          <td><button class="cart-btn" onclick="window.removeFromCart(${i})">ÂâäÈô§</button></td>
          <td>¬•${item.price*item.qty}</td>
        </tr>
      `).join('')}
    `;
    window.changeQty = (i, delta) => {
      cart[i].qty += delta;
      if (cart[i].qty < 1) cart[i].qty = 1;
      renderCart();
    };
    window.removeFromCart = i => {
      cart.splice(i,1);
      renderCart();
    };
  }

  // „Çø„Ç§„Éà„É´„ÇØ„É™„ÉÉ„ÇØ„ÅßÂ±ïÈñã/Ê†ºÁ¥ç
  document.getElementById('cart-title').onclick = () => {
    cartExpanded = !cartExpanded;
    renderCart();
  };

  // „Ç´„Çπ„Çø„É†„É°„Éã„É•„ÉºËøΩÂä†
  document.getElementById('custom-menu-add').onclick = () => {
    const name = document.getElementById('custom-menu-name').value.trim() || '„Ç´„Çπ„Çø„É†';
    const price = parseInt(document.getElementById('custom-menu-price').value, 10) || 0;
    if (price <= 0) {
      alert('ÈáëÈ°ç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
      return;
    }
    // „Ç´„Çπ„Çø„É†„É°„Éã„É•„Éº„Çí„Äå„Åù„ÅÆ‰ªñ„Äç„Ç´„ÉÜ„Ç¥„É™„Å´ËøΩÂä†
    customMenuItems.unshift({ name, price, category: '„Åù„ÅÆ‰ªñ' });
    renderMenuTabs();
    // ËøΩÂä†Âæå„ÄÅ„Çø„Éñ„Çí„Äå„Åù„ÅÆ‰ªñ„Äç„Å´Ëá™Âãï„ÅßÂàá„ÇäÊõø„Åà
    const idx = fixedCategories.indexOf('„Åù„ÅÆ‰ªñ');
    if (idx !== -1) switchTab(idx);
    // ÂÖ•ÂäõÊ¨Ñ„ÇØ„É™„Ç¢
    document.getElementById('custom-menu-name').value = '';
    document.getElementById('custom-menu-price').value = '';
  };
</script>
</body>
</html>
