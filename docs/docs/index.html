<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å±…é…’å±‹ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨ˆç®—æ©Ÿ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <link rel="stylesheet" href="style.css">
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    const firebaseConfig = {
      apiKey: "AIzaSyAluOeFF-oeeYMf7qe3b2vQyMsO_0oetW8",
      authDomain: "izakaya-staff-app.firebaseapp.com",
      projectId: "izakaya-staff-app",
      storageBucket: "izakaya-staff-app.firebasestorage.app",
      messagingSenderId: "44853351550",
      appId: "1:44853351550:web:3b089746d5031ce82cf42f",
      measurementId: "G-9HX2780DVZ"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db;
    window.fs = { collection, query, orderBy, onSnapshot };
  </script>
</head>
<body>
  <div class="app-bar">ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨ˆç®—æ©Ÿ</div>
  <div id="tab-container" class="tab-wrap"></div>
  <div id="drink-subtab-container" class="tab-wrap" style="display:none;"></div>
  <div id="menu-panels"></div>
  <div class="cart-wrap" id="cart-wrap" style="display:none;">
    <div id="cart-summary" style="font-weight:bold; margin-bottom:0.3em;"></div>
    <div id="cart-total" style="font-weight:bold; margin-bottom:0.3em; color:#b71c1c;"></div>
    <div class="cart-title" id="cart-title" style="cursor:pointer; user-select:none;">
      ğŸ›’ é¸æŠä¸­ãƒ¡ãƒ‹ãƒ¥ãƒ¼ <span id="cart-toggle" style="font-size:0.95em; margin-left:8px;">â–¼</span>
    </div>
    <div id="cart-detail">
      <table class="cart-table" id="cart-table"></table>
    </div>
  </div>
  <nav class="bottom-navbar">
  <button class="nav-btn active" id="nav-menu"><span>ğŸ½ï¸</span><br>ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨ˆç®—æ©Ÿ</button>
  <button class="nav-btn" id="nav-inventory"><span>ğŸ“¦</span><br>åœ¨åº«ç®¡ç†</button>
  <button class="nav-btn" id="nav-sake"><span>ğŸ¶</span><br>æ—¥æœ¬é…’</button>
  <button class="nav-btn" id="nav-menu-edit"><span>ğŸ“</span><br>ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†</button>
</nav>
<script>
  // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ãƒšãƒ¼ã‚¸é·ç§»
  document.getElementById('nav-menu').onclick = () => location.href = 'home.html';
  document.getElementById('nav-inventory').onclick = () => location.href = 'inventory.html';
  document.getElementById('nav-sake').onclick = () => location.href = 'sake.html';
  document.getElementById('nav-menu-edit').onclick = () => location.href = 'menu_edit.html';
</script>
  <script type="module">

    // ã‚«ãƒ†ã‚´ãƒªï¼†ãƒ‰ãƒªãƒ³ã‚¯ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã®å›ºå®šé †
    const fixedCategories = [
      'ãƒ‰ãƒªãƒ³ã‚¯', 'ç„¼ãç‰©', 'ä¸€å“æ–™ç†', 'ãŠã¤ã¾ã¿', 'ã‚µãƒ©ãƒ€', 'é‹', 'ãƒˆãƒƒãƒ”ãƒ³ã‚°', 'ã€†ãƒ¡ãƒ‹ãƒ¥ãƒ¼', 'ãƒ‡ã‚¶ãƒ¼ãƒˆ', 'ãã®ä»–'
    ];
    const drinkOrder = [
      'ãƒ“ãƒ¼ãƒ«', 'ã‚µãƒ¯ãƒ¼', 'ãƒã‚¤ãƒœãƒ¼ãƒ«', 'æ—¥æœ¬é…’', 'ç„¼é…', 'ãƒ¯ã‚¤ãƒ³', 'ã‚½ãƒ•ãƒˆãƒ‰ãƒªãƒ³ã‚¯', 'ãã®ä»–'
    ];

    const tabContainer = document.getElementById('tab-container');
    const drinkSubtabContainer = document.getElementById('drink-subtab-container');
    const menuPanels = document.getElementById('menu-panels');
    let menuItems = []; // å…¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼
    let cart = []; // {name, price, qty}
    let currentTabIdx = 0;
    let currentDrinkSubIdx = 0;
    let otoshiAdded = false; // ãŠé€šã—è¿½åŠ ãƒ•ãƒ©ã‚°

    // --- Firestoreã‹ã‚‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å–å¾— ---
    const { db, fs } = window;
    const { collection, query, orderBy, onSnapshot } = fs;

    const menuCol = collection(db, 'menu_items');
    const q = query(menuCol, orderBy('category'));

    onSnapshot(q, snap => {
      menuItems = [];
      snap.forEach(d => menuItems.push({id:d.id, ...d.data()}));
      otoshiAdded = false; // ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ›´æ–°æ™‚ã¯ãƒªã‚»ãƒƒãƒˆ
      renderMenuTabs();
      addOtoshiIfNeeded();
    });

    // --- ãŠé€šã—è‡ªå‹•è¿½åŠ  ---
    function addOtoshiIfNeeded() {
      if (otoshiAdded) return;
      // ã€ŒãŠé€šã—ã€ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æ¤œç´¢ï¼ˆåå‰ãŒã€ŒãŠé€šã—ã€ï¼‰
      const otoshi = menuItems.find(item => item.name === 'ãŠé€šã—');
      if (otoshi) {
        // æ—¢ã«ã‚«ãƒ¼ãƒˆã«å…¥ã£ã¦ã„ãªã‘ã‚Œã°è¿½åŠ 
        if (!cart.some(e => e.name === 'ãŠé€šã—')) {
          cart.unshift({ name: otoshi.name, price: otoshi.price, qty: 1 });
        }
        otoshiAdded = true;
        renderCart();
      }
    }

    // --- ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ–ã¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‘ãƒãƒ«æç”» ---
    function renderMenuTabs() {
      // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const grouped = {};
      menuItems.forEach(item => {
        const cat = item.category || 'ãã®ä»–';
        if (!grouped[cat]) grouped[cat] = [];
        grouped[cat].push(item);
      });

      // ã‚¿ãƒ–é †
      const categories = fixedCategories.filter(c => grouped[c]);
      tabContainer.innerHTML = '';
      menuPanels.innerHTML = '';
      drinkSubtabContainer.style.display = 'none';

      // ã‚¿ãƒ–ä½œæˆ
      categories.forEach((cat, idx) => {
        const btn = document.createElement('button');
        btn.className = 'tab' + (idx===0?' active':'');
        btn.textContent = cat;
        btn.onclick = () => switchTab(idx);
        tabContainer.appendChild(btn);
      });

      // ãƒ‘ãƒãƒ«ä½œæˆ
      categories.forEach((cat, idx) => {
        const panel = document.createElement('div');
        panel.className = 'menu-panel' + (idx===0?' active':'');
        panel.dataset.cat = cat;
        menuPanels.appendChild(panel);
      });

      // åˆæœŸè¡¨ç¤º
      renderMenuPanel(categories[0], 0);
    }

    // --- ã‚¿ãƒ–åˆ‡æ›¿ ---
    function switchTab(idx) {
      currentTabIdx = idx;
      document.querySelectorAll('.tab').forEach((el,i) => el.classList.toggle('active',i===idx));
      document.querySelectorAll('.menu-panel').forEach((el,i) => el.classList.toggle('active',i===idx));
      const categories = Array.from(document.querySelectorAll('.tab')).map(el => el.textContent);
      renderMenuPanel(categories[idx], idx);
    }

    // --- ã‚µãƒ–ã‚¿ãƒ–åˆ‡æ›¿ ---
    function switchDrinkSubTab(subIdx) {
      currentDrinkSubIdx = subIdx;
      document.querySelectorAll('.drink-subtab').forEach((el,i) => el.classList.toggle('active',i===subIdx));
      renderMenuPanel('ãƒ‰ãƒªãƒ³ã‚¯', currentTabIdx, subIdx);
    }

    // --- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‘ãƒãƒ«æç”» ---
    function renderMenuPanel(cat, idx, drinkSubIdx = 0) {
      const panel = document.querySelectorAll('.menu-panel')[idx];
      panel.innerHTML = '';
      if (cat === 'ãƒ‰ãƒªãƒ³ã‚¯') {
        // ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        const grouped = {};
        menuItems.filter(item => item.category === 'ãƒ‰ãƒªãƒ³ã‚¯').forEach(item => {
          const sub = item.subCategory || 'ãã®ä»–';
          if (!grouped[sub]) grouped[sub] = [];
          grouped[sub].push(item);
        });
        const sortedSub = [
          ...drinkOrder.filter(s => grouped[s]),
          ...Object.keys(grouped).filter(s => !drinkOrder.includes(s)),
        ];
        // ã‚µãƒ–ã‚¿ãƒ–ç”Ÿæˆ
        drinkSubtabContainer.innerHTML = '';
        drinkSubtabContainer.style.display = 'flex';
        sortedSub.forEach((sub, i) => {
          const btn = document.createElement('button');
          btn.className = 'tab drink-subtab' + (i===drinkSubIdx?' active':'');
          btn.textContent = sub;
          btn.onclick = () => switchDrinkSubTab(i);
          drinkSubtabContainer.appendChild(btn);
        });
        // ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã®ã‚°ãƒªãƒƒãƒ‰ã®ã¿è¡¨ç¤º
        const subCat = sortedSub[drinkSubIdx] || sortedSub[0];
        if (subCat) {
          const grid = document.createElement('div');
          grid.className = 'grid';
          grouped[subCat].forEach(item => grid.appendChild(buildMenuCard(item)));
          panel.appendChild(grid);
        }
      } else {
        drinkSubtabContainer.style.display = 'none';
        // ãã®ä»–ã‚«ãƒ†ã‚´ãƒªã¯é€šå¸¸ã‚°ãƒªãƒƒãƒ‰
        const grid = document.createElement('div');
        grid.className = 'grid';
        menuItems.filter(item => item.category === cat).forEach(item => grid.appendChild(buildMenuCard(item)));
        panel.appendChild(grid);
      }
    }

    // --- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚«ãƒ¼ãƒ‰ ---
    function buildMenuCard(item) {
      const card = document.createElement('div');
      card.className = 'menu-card';
      card.innerHTML = `<div class="menu-name">${item.name}</div>
        <div class="menu-price">Â¥${item.price}</div>`;
      card.onclick = () => addToCart(item.name, item.price, 1);
      return card;
    }

    // --- ã‚«ãƒ¼ãƒˆã«è¿½åŠ  ---
    function addToCart(name, price, qty) {
      // ãŠé€šã—è‡ªå‹•è¿½åŠ 
      addOtoshiIfNeeded();
      const idx = cart.findIndex(e => e.name === name && e.price === price);
      if (idx >= 0) cart[idx].qty += qty;
      else cart.push({ name, price, qty });
      renderCart();
    }

    // --- ã‚«ãƒ¼ãƒˆè¡¨ç¤ºãƒ»æ•°é‡å¤‰æ›´ ---
    let cartExpanded = true;
    function renderCart() {
      const wrap = document.getElementById('cart-wrap');
      const table = document.getElementById('cart-table');
      const detail = document.getElementById('cart-detail');
      const toggle = document.getElementById('cart-toggle');
      const summary = document.getElementById('cart-summary');
      const totalEl = document.getElementById('cart-total');
      if (!cart.length) { wrap.style.display = 'none'; return; }
      wrap.style.display = 'block';

      // å°è¨ˆãƒ»ç¨è¾¼ã¿è¨ˆç®—
      const subtotal = cart.reduce((sum,e)=>sum+e.price*e.qty,0);
      const tax = Math.round(subtotal * 0.1);
      const total = subtotal + tax;
      summary.innerHTML = `å°è¨ˆ: Â¥${subtotal.toLocaleString()}ã€€ç¨è¾¼: Â¥${total.toLocaleString()}`;
      totalEl.innerHTML = `åˆè¨ˆ: <span style="font-size:1.13em;">Â¥${total.toLocaleString()}</span>`;

      // å±•é–‹ãƒ»æ ¼ç´
      detail.style.display = cartExpanded ? 'block' : 'none';
      toggle.textContent = cartExpanded ? 'â–¼' : 'â–²';

      // --- ã‚«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆéƒ¨åˆ†ã‚’ä¿®æ­£ ---
      table.innerHTML = `
        <tr>
          <th>å•†å“å</th><th>å˜ä¾¡</th><th>æ•°é‡</th><th></th><th>å°è¨ˆ</th>
        </tr>
        ${cart.map((item, i) => `
          <tr>
            <td>${item.name}</td>
            <td>Â¥${item.price}</td>
            <td>
              <button class="qty-btn" onclick="window.changeQty(${i},-1)">âˆ’</button>
              ${item.qty}
              <button class="qty-btn" onclick="window.changeQty(${i},1)">ï¼‹</button>
            </td>
            <td><button class="cart-btn" onclick="window.removeFromCart(${i})">å‰Šé™¤</button></td>
            <td>Â¥${item.price*item.qty}</td>
          </tr>
        `).join('')}
      `;
      window.changeQty = (i, delta) => {
        cart[i].qty += delta;
        if (cart[i].qty < 1) cart[i].qty = 1;
        renderCart();
      };
      window.removeFromCart = i => {
        cart.splice(i,1);
        renderCart();
      };
    }

    // ã‚¿ã‚¤ãƒˆãƒ«ã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹/æ ¼ç´
    document.getElementById('cart-title').onclick = () => {
      cartExpanded = !cartExpanded;
      renderCart();
    };
  </script>
</body>
</html>
